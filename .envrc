# Direnv configuration for Vivian Backend
# Install direnv: brew install direnv
# Then run: direnv allow

# Python version to use
export PYTHON_VERSION="3.11"

# Check if we're in a virtual environment
if [ -z "$VIRTUAL_ENV" ]; then
    if [ -d "apps/api/.venv" ]; then
        echo "üêç Activating API virtual environment..."
        source apps/api/.venv/bin/activate
    elif [ -d ".venv" ]; then
        echo "üêç Activating root virtual environment..."
        source .venv/bin/activate
    elif [ -d "venv" ]; then
        echo "üêç Activating legacy virtual environment..."
        source venv/bin/activate
    else
        echo "‚ö†Ô∏è  No virtual environment found."
        echo "   To create one for API testing:"
        echo "   python3 -m venv .venv && source .venv/bin/activate && pip install -e \".[test]\""
    fi
fi

# Helper functions and aliases
use_api_env() {
    if [ -d "apps/api/.venv" ]; then
        source apps/api/.venv/bin/activate
    elif [ -d ".venv" ]; then
        source .venv/bin/activate
    elif [ -d "venv" ]; then
        source venv/bin/activate
    else
        echo "‚ö†Ô∏è  No API virtual environment found."
        echo "   Create one: cd apps/api && python3 -m venv .venv && source .venv/bin/activate && pip install -e \".[test]\""
        return 1
    fi
}

use_mcp_env() {
    if [ -d "apps/test-mcp-server/venv" ]; then
        source apps/test-mcp-server/venv/bin/activate
    else
        echo "‚ö†Ô∏è  No MCP virtual environment found."
        echo "   Create one: cd apps/test-mcp-server && python3 -m venv venv && source venv/bin/activate && pip install -e \".[test]\""
        return 1
    fi
}

alias test-api="use_api_env && pytest apps/api/tests"
alias test-mcp="cd apps/test-mcp-server && use_mcp_env && pytest"
alias test-all="use_api_env && pytest && (cd apps/test-mcp-server && use_mcp_env && pytest)"
alias seed-id="docker compose exec -T api python scripts/seed_identity.py"

echo "üöÄ Vivian Backend ready!"
echo "   Run tests: test-api | test-mcp | test-all"
echo "   Run MCP tests only: test-mcp"
echo "   Seed identity data: seed-id --home-name \"My Home\" --seed-all-roles"
